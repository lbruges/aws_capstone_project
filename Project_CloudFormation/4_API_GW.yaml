Parameters:
  PublishStageName:
    Type: String
    Default: prod

Resources:
  UtilitiesApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: MyUtilitiesApi
      ProtocolType: HTTP
  PublishLambdaIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref UtilitiesApi
      Description: Publish Lambda API GW Integration
      IntegrationType: AWS_PROXY
      PayloadFormatVersion: "2.0"
      IntegrationUri: !ImportValue FunctionLambdaForPublishArn
  PublishLambdaApiRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref UtilitiesApi
      RouteKey: "PUT /api/report"
      Target: !Ref PublishLambdaIntegration
      AuthorizationType: NONE
  PublishLambdaApiRouteResponse:
    Type: AWS::ApiGatewayV2::RouteResponse
    Properties:
      ApiId: !Ref UtilitiesApi
      RouteId: !Ref PublishLambdaApiRoute
      RouteResponseKey: 200
  UtilitiesApiStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref UtilitiesApi
      StageName: !Ref PublishStageName
      AutoDeploy: true
      CorsConfiguration:
        AllowOrigins:
          - '*'
        AllowMethods:
          - GET
          - PUT
          - POST
        AllowedHeaders:
          - Authorization
          - Content-Type
          - X-Requested-With
Outputs:
  ApiGwUrl:
    Description: "Publish Report API endpoint URL"
    Value: !Sub "https://${UtilitiesApi}.execute-api.${AWS::Region}.amazonaws.com/${PublishStageName}"